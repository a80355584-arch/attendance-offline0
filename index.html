<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Attendance Offline</title>
</head>
<body>

<h2>ğŸ“‹ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±</h2>
<div id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxARLTg5bYpJjOPVMbW-Oopvvh5h0tI33J6swRkKs1i5216diTMn46Z13ve_PUSaSNG/exec"; // Ø±Ø§Ø¨Ø·Ùƒ
const params = new URLSearchParams(window.location.search);
const code = params.get("code");

if (!code) {
  document.getElementById("status").innerText = "âŒ QR ØºÙŠØ± ØµØ§Ù„Ø­";
  throw "";
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
let queue = JSON.parse(localStorage.getItem("attendanceQueue") || "[]");

// Ø¥Ø¶Ø§ÙØ© ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
queue.push({
  code: code,
  time: new Date().toISOString()
});

// Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
localStorage.setItem("attendanceQueue", JSON.stringify(queue));

document.getElementById("status").innerText =
  "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø£ÙˆÙÙ„Ø§ÙŠÙ†)";

// Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
syncData();

function syncData() {
  if (!navigator.onLine) return;

  let queue = JSON.parse(localStorage.getItem("attendanceQueue") || "[]");
  if (queue.length === 0) return;

  const item = queue[0];

  fetch(`${SCRIPT_URL}?code=${item.code}`)
    .then(r => r.text())
    .then(() => {
      queue.shift(); // Ø­Ø°Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
      localStorage.setItem("attendanceQueue", JSON.stringify(queue));
      syncData(); // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
    })
    .catch(() => {
      console.log("Ù„Ø³Ù‡ Ù…ÙÙŠØ´ Ù†Øª");
    });
}

// Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„Ù†Øª ÙŠØ±Ø¬Ø¹
window.addEventListener("online", syncData);
</script>

</body>
</html>

